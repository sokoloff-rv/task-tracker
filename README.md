# Task Tracker API

REST API для управления задачами с токен-аутентификацией на базе Laravel. Приложение позволяет регистрировать и авторизовывать пользователей, создавать и сопровождать задачи, прикреплять файлы к задачам и получать уведомления о создании задач по email.

Работоспобная версия доступна по адресу https://task-tracker.sokoloff-rv.ru (только реальная отправка email не происходит, все письма падают в Mailtrap).

## Основные возможности
- Регистрация и авторизация пользователей по токену (`Laravel Sanctum`).
- CRUD для задач с фильтрацией по статусу, исполнителю и дате завершения.
- Статусы задач: `planned`, `in_progress`, `done`.
- Привязка автора и исполнителя задачи (пользователь).
- Поддержка даты завершения и опционального вложения.
- Загрузка файлов через `spatie/laravel-medialibrary` с выдачей ссылки в ответе.
- Отправка email-уведомления после создания задачи (адрес исполнителя или автора).
- Единообразные JSON-ответы и человекочитаемые сообщения о валидации.

## Требования
- PHP 8.2+
- Composer
- Node.js и npm (для сборки фронтенда при необходимости)
- СУБД (MySQL/PostgreSQL/SQLite и т.д.)

## Развертывание
1. Клонируйте репозиторий и установите зависимости:
   ```bash
   composer install
   npm install
   ```
2. Создайте файл окружения и сгенерируйте ключ приложения:
   ```bash
   cp .env.example .env
   php artisan key:generate
   ```
3. Настройте подключение к базе данных и параметры почты в `.env`:
   ```env
   DB_CONNECTION=mysql
   DB_HOST=127.0.0.1
   DB_PORT=3306
   DB_DATABASE=task_tracker
   DB_USERNAME=root
   DB_PASSWORD=secret

   MAIL_MAILER=log   # Для локальной разработки: письма пишутся в логи
   # MAIL_HOST=...    # Или настройте SMTP, если нужно отправлять письма
   ```
4. Выполните миграции и создайте симлинк на директорию файлов:
   ```bash
   php artisan migrate
   php artisan storage:link
   ```
5. Соберите фронтенд (если требуется) и запустите сервер разработки:
   ```bash
   npm run build   # или npm run dev
   php artisan serve
   ```

## Аутентификация
Используется Laravel Sanctum. Полученный `token` необходимо передавать в заголовке `Authorization: Bearer <token>` для всех защищённых маршрутов.

### Регистрация
`POST /api/registration`

**Тело запроса**
```json
{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "Password123!"
}
```

**Ответ 201**
```json
{
  "message": "Пользователь успешно зарегистрирован!",
  "user": { /* данные пользователя */ },
  "token": "<plain-text-token>"
}
```

### Логин
`POST /api/login`

**Тело запроса**
```json
{
  "email": "john@example.com",
  "password": "Password123!"
}
```

**Ответ 200**
```json
{
  "message": "Авторизация прошла успешно!",
  "user": { /* данные пользователя */ },
  "token": "<plain-text-token>"
}
```

## Задачи
Все маршруты `/api/tasks` защищены Sanctum. В ответах задачи возвращаются вместе с автором, исполнителем и ссылкой на вложение (если оно есть) в поле `attachment_url`.

### Получение списка задач
`GET /api/tasks`

Параметры фильтрации (все необязательны):
- `status` — один из `planned`, `in_progress`, `done`;
- `assignee_id` — ID исполнителя;
- `due_date` — дата завершения в формате `YYYY-MM-DD`.

**Ответ 200**
```json
{
  "message": "Список из <N> задач успешно получен!",
  "tasks": [
    {
      "id": 1,
      "title": "...",
      "status": "planned",
      "due_date": "2025-11-30",
      "assignee": { /* пользователь */ },
      "author": { /* пользователь */ },
      "attachment_url": "http://.../storage/..."
    }
  ]
}
```

### Создание задачи
`POST /api/tasks`

- Тело передаётся в формате `multipart/form-data` при загрузке файлов (ключ `attachment`).
- При успешном создании отправляется email исполнителю (`assignee`) или автору, если исполнитель не указан.

**Поля**
- `title` (string, required, max 255)
- `description` (string, required)
- `status` (enum, required: `planned`|`in_progress`|`done`)
- `due_date` (date, optional)
- `assignee_id` (integer, optional, существующий пользователь)
- `attachment` (file, optional, до 10 МБ)

**Ответ 201**
```json
{
  "message": "Задача успешно создана!",
  "task": { /* данные задачи */ },
  "attachment_url": "http://.../storage/..." // null, если файла нет
}
```

### Просмотр задачи
`GET /api/tasks/{id}`

**Ответ 200**
```json
{
  "message": "Задача успешно получена!",
  "task": { /* данные задачи */ },
  "attachment_url": "http://.../storage/..."
}
```

### Обновление задачи
`PUT /api/tasks/{id}`

Поддерживает частичное обновление. Поля аналогичны созданию, но все опциональны. Вложение можно передать заново в `attachment` — оно заменит существующее.

**Ответ 200**
```json
{
  "message": "Задача успешно обновлена!",
  "task": { /* обновлённая задача */ },
  "attachment_url": "http://.../storage/..."
}
```

### Удаление задачи
`DELETE /api/tasks/{id}`

**Ответ 200**
```json
{
  "message": "Задача успешно удалена!"
}
```

## Валидация и ошибки
При ошибках валидации API возвращает код `422` и список ошибок:
```json
{
  "message": "Ошибка валидации данных!",
  "errors": {
    "field": ["Сообщение об ошибке"]
  }
}
```
При неверных учетных данных для логина возвращается `401` с сообщением `"Неверный email или пароль!"`.

## Работа с вложениями
- Загрузка и хранение реализованы через пакет `spatie/laravel-medialibrary` (локальное хранилище по умолчанию).
- Используйте `php artisan storage:link` для доступа к файлам через публичный URL.
- В ответах API ссылка на вложение доступна в поле `attachment_url`; `null`, если файл отсутствует.

## Отправка почты
После создания задачи отправляется письмо на email исполнителя. Если исполнитель не указан, письмо получает автор задачи.
